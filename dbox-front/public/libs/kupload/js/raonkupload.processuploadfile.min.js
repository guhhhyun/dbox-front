var G_LoadSecurityJs=!1,G_LoadCompressJs=!1,G_LoadCryptoJs=!1;importScripts("raonkupload.base64.js");importScripts("raonkupload.xhr.js");var G_formfeed="\f",G_vertical="\x0B",G_xhr=null,CryptoJS=null;function makeGuidTagName(a){var b=0,d=(new Date).getTime().toString(32),e;for(e=0;5>e;e++)d+=Math.floor(65535*Math.random()).toString(32);return(a||"o_")+d+(b++).toString(32)}
function upload(a){"1"!=a.security.fileEncrypt&&"2"!=a.security.fileEncrypt&&"2"!=a.security.encryptParam||null!=CryptoJS||importScripts("aes.js");if(null==G_xhr||void 0==G_xhr)G_xhr=new XMLHttpRequest;var b=a.handlerUrl,b=-1<b.indexOf("?")?b+("&raonk="+makeGuidTagName("urk_")):b+("?raonk="+makeGuidTagName("urk_"));G_xhr.open("POST",b,a.asyncUpload);var d=a.chunk.size;try{G_xhr.upload.onprogress=function(b){b=parseInt(b.loaded/b.total*a.chunk.size*1,10);self.postMessage({type:"chunkProgress",chunkLoadedSize:b})}}catch(e){}G_xhr.onreadystatechange=
function(){if(4==G_xhr.readyState)if(200==G_xhr.status){var b=RaonKBase64.parseDataFromServer(G_xhr.responseText);if("[OK]"==b)self.postMessage({type:"progress",paramObj:{uploadedSize:d,workerId:a.workerId,uploadIdx:a.uploadIdx,path:a.path}});else if(0==b.indexOf("[FAIL]")){var b=b.replace("[FAIL]",""),b=RaonKBase64.makeDecryptReponseMessage(b,a.security),b=b.split("|"),n="",c="";0==b.length?c=b[0]:(n=b[0],c=b[1]);self.postMessage({type:"error",code:n,message:c,id:a.id});G_xhr=void 0;self.close()}}else if(400<=
G_xhr.status&&600>G_xhr.status||0==G_xhr.status)self.postMessage({type:"error",code:"C009",message:"Http Status Code: "+G_xhr.status,id:a.id}),G_xhr=void 0,self.close()};var c="",k=function(){try{G_xhr.send(c),c=void 0}catch(b){self.postMessage({type:"error",code:"C000",message:b.message,workerId:a.workerId}),G_xhr=void 0}},b=""+("kc"+G_formfeed+"c02"+G_vertical),b=b+("k01"+G_formfeed+a.security.encryptParam+G_vertical);0<a.security.fileEncrypt&&(b+="k02"+G_formfeed+a.security.fileEncrypt+G_vertical);
b+="k03"+G_formfeed+(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:a.security.fileIntegrity)+G_vertical;"0"!=a.compress&&(b+="k04"+G_formfeed+3+G_vertical);b+="k05"+G_formfeed+a.resumeUpload+G_vertical;b+="k12"+G_formfeed+a.guid+G_vertical;b+="k19"+G_formfeed+a.startPos+G_vertical;b+="k26"+G_formfeed+a.path;a.cloudInfoUse&&"2"==a.cloudInfoUse&&(b+=G_vertical,b+="k46"+G_formfeed+a.cloudInfoUse+G_vertical,b+="k27"+G_formfeed+a.partNumber+G_vertical,b+="k48"+G_formfeed+a.partSize);
"1"==a.useKMonitoring&&(b+=G_vertical+"km0"+G_formfeed+a.trasnferId+G_vertical,b+="km3"+G_formfeed+a.previousUploadSize+G_vertical);b=RaonKBase64.makeEncryptParamFinal(a.security,b);if("undefined"==typeof FormData){var h=makeGuidTagName("----raonk_"),f=function(a){G_xhr&&(G_xhr.setRequestHeader("Content-Type","multipart/form-data; boundary="+h),G_xhr.setRequestHeader("RAONK-Encoded","base64"));c=a;k()};try{buildFormData(a,b,h,f)}catch(l){self.postMessage({type:"error",code:"C001",message:l.message,
workerId:a.workerId}),G_xhr=void 0}}else{c=new FormData;c.append(b.name,b.value);var g;if("1"==(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:a.security.fileIntegrity)||"0"!=a.compress||"0"!=a.security.fileEncrypt){g=new FileReaderSync;try{f=g.readAsArrayBuffer(a.chunk),g=void 0}catch(m){g=void 0,self.postMessage({type:"error",code:"C009",message:"Http Status Code: "+G_xhr.status,id:a.id}),G_xhr=void 0,self.close()}}b="";if("1"==(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:
a.security.fileIntegrity)){G_LoadSecurityJs||(importScripts("raonkupload.fdi.aes.js"),importScripts("hmac-sha256.js"),G_LoadSecurityJs=!0);try{b=D5FileDataIntegrity(f,a.security.keyValue.substring(0,11),!0).toString()}catch(n){self.postMessage({type:"error",code:"C009",message:"Http Status Code: "+G_xhr.status,id:a.id}),G_xhr=void 0,self.close()}c.append("k25",b)}var p=function(a){c.append("Slice",a);k()};"0"!=a.compress?makeZipData(a.uploadIdx,f,function(b){0<a.security.fileEncrypt?(g=new FileReaderSync,
newData=g.readAsArrayBuffer(b),g=void 0,encryptFileData(newData,a.security.keyValue.substring(0,11),16*a.security.fileEncrypt,p)):(c.append("Slice",b),k())}):0<a.security.fileEncrypt?encryptFileData(f,a.security.keyValue.substring(0,11),16*a.security.fileEncrypt,p):(c.append("Slice",a.chunk),k())}}self.onmessage=function(a){a=a.data;switch(a.type){case "upload":upload(a.uploadData);break;case "check_formdata":a=!0,"undefined"==typeof FormData&&(a=!1),self.postMessage({type:"check_formdata",isFormDataSupport:a})}};
function buildFormData(a,b,d,e){var c=new FileReaderSync,k=c.readAsDataURL(a.chunk),h=k.match(/,(.*)$/)[1],f,l,g=function(){var a;a=""+("--"+d+'\r\nContent-Disposition: form-data; name="'+b.name+'"');a+="\r\n\r\n";a+=b.value;a+="\r\n";a+="--"+d+'\r\nContent-Disposition: form-data; name="Slice"; filename="blob"';a+="\r\n";a+="Content-Type: application/octet-stream";a+="\r\n";a+="\r\n";a+=h;a+="\r\n";l&&(a+="--"+d+'\r\nContent-Disposition: form-data; name="k25"',a+="\r\n",a+="\r\n",a+=l,a+="\r\n");
a+="--"+d+"--\r\n";c=k=h=void 0;e(a)};"1"==(""!=a.security.fileIntegrityUpload?a.security.fileIntegrityUpload:a.security.fileIntegrity)&&(G_LoadSecurityJs||(importScripts("raonkupload.fdi.aes.js"),importScripts("hmac-sha256.js"),G_LoadSecurityJs=!0),f=c.readAsArrayBuffer(a.chunk),l=D5FileDataIntegrity(f,a.security.keyValue,!0).toString());var m=function(a){h=c.readAsDataURL(a).match(/,(.*)$/)[1];g()};"0"!=a.compress?(f||(f=c.readAsArrayBuffer(a.chunk)),makeZipData(a.uploadIdx,f,function(b){0<a.security.fileEncrypt?
encryptFileData(c.readAsArrayBuffer(b),a.security.keyValue.substring(0,11),16*a.security.fileEncrypt,m):(h=c.readAsDataURL(b).match(/,(.*)$/)[1],g())})):0<a.security.fileEncrypt?(f||(f=c.readAsArrayBuffer(a.chunk)),encryptFileData(f,a.security.keyValue.substring(0,11),16*a.security.fileEncrypt,m)):g()}
function makeZipData(a,b,d){G_LoadCompressJs||(importScripts("jszip/jszip.js"),G_LoadCompressJs=!0);var e=new JSZip;e.file(a,b);e.generateAsync({type:"blob",compression:"deflate",compressionOptions:{level:9},comment:"RAONWIZ"},function(a){}).then(function(a){"function"==typeof d&&d(a);e=void 0})}
function encryptFileData(a,b,d,e){var c;try{c=crypto||msCrypto}catch(k){}if(c&&c.subtle){var h=stringToBytes(b);b=new Uint8Array(d);b.set(h);var f=c.subtle.importKey("raw",b,{name:"AES-CBC"},!1,["encrypt","decrypt"]);f.then(function(b){var d=new Uint8Array(16);d.set(h);c.subtle.encrypt({name:"AES-CBC",iv:d},b,a).then(function(a){a=makeBlob(a);e(a)})["catch"]=function(a){self.postMessage({type:"error",code:"C011",message:a.message||a,workerId:workerData.workerId})}})["catch"]=function(a){self.postMessage({type:"error",
code:"C011",message:a.message||a,workerId:workerData.workerId})}}else G_LoadCryptoJs||(G_LoadSecurityJs||importScripts("raonkupload.fdi.aes.js"),G_LoadCryptoJs=!0),f=CryptoJS.enc.Utf8.parse(b),f.sigBytes=d,wordArrayData=arrayBufferToWordArray(a),b=CryptoJS.AES.encrypt(wordArrayData,f,{iv:CryptoJS.enc.Utf8.parse(b)}),wordArrayData=void 0,b=makeBlob(convertWordArrayToUint8Array(b.ciphertext)),e(b)}
function arrayBufferToBase64(a){var b="";a=new Uint8Array(a);for(var d=a.byteLength,e=0;e<d;e++)b+=String.fromCharCode(a[e]);return btoa(b)}function stringToBytes(a){for(var b,d,e=[],c=0;c<a.length;c++){b=a.charCodeAt(c);d=[];do d.push(b&255),b>>=8;while(b);e=e.concat(d.reverse())}return e}var makeBlob=function(a){var b=[];b.push(a);return new Blob(b,{type:"application/octet-stream"})};
